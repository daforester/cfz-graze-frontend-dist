import{I as J,a0 as B,a1 as le,M as c,N as k,O as t,v as e,r as v,K as W,w as Q,e as ne,W as X,a3 as ae,V as E,H as F,a4 as ie,P as M,Q as C,X as d,R as _e,a6 as we,S as L,ac as Te,E as se}from"./index-bd850ea9.js";import{O as G,G as S}from"./group-d2a77946.js";import{P as Ne}from"./permission-03f04c02.js";import{j as te}from"./VContainer-56a5604e.js";import{a as R,V as oe}from"./VRow-adaee2c8.js";import{V as j,u as ue}from"./VCheckbox-5d59ed96.js";import{_ as De}from"./DeleteDialog.vue_vue_type_script_setup_true_lang-eb6937e0.js";import{_ as re}from"./ModelDialog.vue_vue_type_script_setup_true_lang-385850d5.js";import{V as he}from"./VTextField-d3028014.js";import{V as ee,c as be}from"./copyToClipboard-2ee69ae7.js";import{u as Y}from"./nil-d01db1aa.js";import{G as ye,A as Ee}from"./userData-123e8d08.js";import{u as Ge}from"./useAvatar-8e8abb6f.js";import{_ as Re,l as Pe}from"./SaveButton.vue_vue_type_script_setup_true_lang-2fb7c102.js";import{V as Ce,a as Se,d as ke}from"./VList-0846e66f.js";import{V as x}from"./VBtn-95d6ccee.js";import{V as Me}from"./VAvatar-0c751efb.js";import{V as Ae}from"./VDialog-b07a91a3.js";import{e as Ye,V as xe,a as Le,c as je,d as $e}from"./VCard-39a2284c.js";import{V as de}from"./scopeId-87dadda8.js";import{a as We,V as Fe}from"./VTable-c80f256f.js";import{V as Be}from"./VToolbar-df07c74c.js";import{v as K}from"./v4-a960c1f4.js";import"./forwardRefs-6eff7908.js";import"./VChip-462fc16a.js";import"./createSimpleFunctional-32d328ca.js";import"./VDivider-a486b43e.js";const me=J({__name:"EditGroupPermissions",props:B({disabled:{type:Boolean}},{modelValue:{required:!0}}),emits:["update:modelValue"],setup(P){const U=le(P,"modelValue");return(V,m)=>(c(),k(te,null,{default:t(()=>[e(oe,null,{default:t(()=>[e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e(j,{modelValue:U.value.EditConvention,"onUpdate:modelValue":m[0]||(m[0]=p=>U.value.EditConvention=p),label:"Edit Convention","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e(j,{modelValue:U.value.EditOrganisation,"onUpdate:modelValue":m[1]||(m[1]=p=>U.value.EditOrganisation=p),label:"Edit Organisation","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e(j,{modelValue:U.value.EditRegistration,"onUpdate:modelValue":m[2]||(m[2]=p=>U.value.EditRegistration=p),label:"Edit Registrations","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e(j,{modelValue:U.value.ManageUsers,"onUpdate:modelValue":m[3]||(m[3]=p=>U.value.ManageUsers=p),label:"Manage Users","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e(j,{modelValue:U.value.ManageViews,"onUpdate:modelValue":m[4]||(m[4]=p=>U.value.ManageViews=p),label:"Manage Views","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e(j,{modelValue:U.value.ViewRegistration,"onUpdate:modelValue":m[5]||(m[5]=p=>U.value.ViewRegistration=p),label:"View Registrations","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}))}}),ze=J({__name:"EditGroupDialog",props:B({conventions:{},organisations:{},group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:B(["update:group","save"],["update:modelValue"]),setup(P,{emit:U}){const V=P,m=ae(),{conventions:p,organisations:A,title:T=""}=V,I=le(P,"modelValue"),r=ue(V,U,void 0,void 0,"group"),a=v(W(r.value)),f=v(null);a.value.OwnerType===G.OWNER_TYPE_CONVENTION?f.value=p.filter(i=>i.ConventionUUID==a.value.OwnerUUID).map(i=>i.ConventionUUID).join(""):a.value.OwnerType===G.OWNER_TYPE_ORGANISATION?f.value=A.filter(i=>i.OrganisationUUID==a.value.OwnerUUID).map(i=>i.OrganisationUUID).join(""):(a.value.Type===S.GROUP_TYPE_SYSTEM||a.value.Type===S.GROUP_TYPE_ADMIN)&&(f.value=null),Q(r,()=>{a.value=W(r.value)});const N=v({ID:0,PermissionUUID:Y,GroupID:0,GroupUUID:Y,EditConvention:!1,EditOrganisation:!1,EditRegistration:!1,ViewRegistration:!1,ManageUsers:!1,ManageViews:!1});m.getPermission(S.GROUP_TYPE_SYSTEM,Y).then(i=>{N.value=i,b()}).catch(()=>{});const D=()=>{a.value=W(r.value),b()},g=i=>{if(f.value==null)a.value.Type=S.GROUP_TYPE_ADMIN,a.value.OwnerType=null,a.value.OwnerID=null,a.value.OwnerUUID=null;else{const s=h.value.find(n=>f.value===n.OwnerUUID);s&&(s.OwnerType==G.OWNER_TYPE_ORGANISATION?a.value.Type=S.GROUP_TYPE_ORGANISATION:s.OwnerType==G.OWNER_TYPE_CONVENTION&&(a.value.Type=S.GROUP_TYPE_CONVENTION),a.value.OwnerType=s.OwnerType,a.value.OwnerID=s.OwnerID,a.value.OwnerUUID=s.OwnerUUID)}m.saveGroup(a.value).then(s=>{s&&i&&i("Group Saved").then(()=>{r.value=s,U("save",s)})}).catch(()=>{i&&i("Failed to Save Group")})},b=()=>{const i=h.value.find(s=>a.value.OwnerUUID===s.OwnerUUID);i?f.value=i.OwnerUUID:h.value.length>0&&(f.value=null)},h=ne(()=>{const i=[];return N.value.ManageUsers&&i.push({Label:"System Admin",OwnerID:null,OwnerUUID:null,OwnerType:null}),i.push(...p.map(s=>({Label:`${s.Name} (Convention)`,OwnerID:s.ID,OwnerUUID:s.ConventionUUID,OwnerType:G.OWNER_TYPE_CONVENTION}))),i.push(...A.map(s=>({Label:`${s.Name} (Organisation)`,OwnerID:s.ID,OwnerUUID:s.OrganisationUUID,OwnerType:G.OWNER_TYPE_ORGANISATION}))),i});return b(),(i,s)=>(c(),k(re,{modelValue:I.value,"onUpdate:modelValue":s[3]||(s[3]=n=>I.value=n),onReset:D,onSave:g,title:X(T),color:"primary","show-close-action":!0,"show-reset-action":!0,"show-save-action":!0,fullscreen:!0,persistent:!0},{default:t(()=>[e(te,{class:"pa-0",fluid:!0},{default:t(()=>[e(oe,null,{default:t(()=>[e(R,{cols:"12",md:"6"},{default:t(()=>[e(he,{modelValue:a.value.Name,"onUpdate:modelValue":s[0]||(s[0]=n=>a.value.Name=n),label:"Name",variant:"outlined"},null,8,["modelValue"])]),_:1}),e(R,{cols:"12",md:"6"},{default:t(()=>[e(ee,{modelValue:f.value,"onUpdate:modelValue":s[1]||(s[1]=n=>f.value=n),label:"Owner",items:h.value,"item-title":"Label","item-value":"OwnerUUID",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),e(R,{cols:"12"},{default:t(()=>[e(me,{modelValue:a.value.Permission,"onUpdate:modelValue":s[2]||(s[2]=n=>a.value.Permission=n),disabled:!1},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"]))}}),qe=d("p",null," Are you sure you wish to remove this user? If they have permissions from another group these will still be usable. To add the user back into the group you may need to provide them with a new invite link. ",-1),He={key:1},Ke=["href","onClick"],Qe=J({__name:"EditGroupMembersDialog",props:B({group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:B(["update:group","save"],["update:modelValue"]),setup(P,{emit:U}){const V=P,m=ae(),p=Ge(),{title:A=""}=V,T=le(P,"modelValue"),I=ue(V,U,void 0,void 0,"group"),r=v(W(I.value));(r.value.Users==null||r.value.Users.length==0)&&m.getGroupMembers(r.value.GroupUUID).then(n=>{n&&(r.value.Users=n)}).catch(()=>{r.value.Users=[]});const a=v(""),f=()=>{m.getGroupInvite(r.value.GroupUUID).then(n=>{if(n){const _=new URL(location.href);_.searchParams.set("token",n),a.value=_.toString()}})};f(),Q(I,()=>{r.value=W(I.value)});const N=()=>{be(a.value),f()},D=v(!1),g=v(-1),b=v(""),h=()=>{g.value=-1,D.value=!1},i=n=>{g.value=n,D.value=!0},s=({callback:n})=>{if(!r.value.Users){n&&(n("Failed to Remove User"),setTimeout(h,2e3));return}b.value="",g.value<0||g.value>=r.value.Users.length?(n&&n("Invalid Convention"),setTimeout(h,2e3)):m.removeUserFromGroup(r.value.Users[g.value].UserUUID,r.value.GroupUUID).then(_=>{var O;_?((O=r.value.Users)==null||O.splice(g.value,1),n&&n("User Removed")):n&&n("Failed to Remove User"),setTimeout(h,2e3)}).catch(()=>{n&&(n("Failed to Remove User"),setTimeout(h,2e3))})};return(n,_)=>(c(),k(re,{modelValue:T.value,"onUpdate:modelValue":_[1]||(_[1]=O=>T.value=O),title:X(A),color:"primary",fullscreen:!0,persistent:!0},{default:t(()=>[e(te,{class:"pa-0",fluid:!0},{default:t(()=>[r.value.Users&&r.value.Users.length?(c(),E(F,{key:0},[e(Ce,null,{default:t(()=>[(c(!0),E(F,null,ie(r.value.Users,(O,$)=>(c(),k(Se,{key:O.UserUUID},{append:t(()=>[e(x,{color:"red-darken-3",icon:"mdi:mdi-window-close",size:"x-small",onClick:z=>i($)},null,8,["onClick"])]),prepend:t(()=>[e(Me,{src:X(p)(O.UserUUID),class:"rounded-circle mr-2",height:"32",width:"32"},null,8,["src"])]),default:t(()=>[e(ke,null,{default:t(()=>[M(C(O.DisplayName)+" "+C(O.Handle?`(${O.Handle})`:""),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(Ae,{modelValue:D.value,"onUpdate:modelValue":_[0]||(_[0]=O=>D.value=O),width:"auto"},{default:t(()=>[e(Ye,null,{default:t(()=>[e(xe,null,{default:t(()=>[M(" Remove User from Group ")]),_:1}),e(Le,null,{default:t(()=>[M(" User will no longer have the permissions from this group. ")]),_:1}),e(je,null,{default:t(()=>[e(oe,null,{default:t(()=>[e(R,null,{default:t(()=>[qe]),_:1})]),_:1})]),_:1}),e($e,null,{default:t(()=>[e(x,{color:"primary",onClick:h},{default:t(()=>[M("Cancel")]),_:1}),e(de),e(Re,{color:"red-darken-3",label:"Remove User",onClick:s})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)):(c(),E("p",He," No members "))]),_:1})]),actions:t(()=>[e(x,{variant:"text"},{default:t(()=>[d("a",{href:a.value,onClick:_e(N,["prevent"])},"Invite URL",8,Ke)]),_:1})]),_:1},8,["modelValue","title"]))}}),Xe=d("h1",{class:"text-center mt-5"},"Processing Invite...",-1),Je={key:0,class:"text-center mt-5 text-red text-h5"},Ze={key:1,class:"text-center mt-5"},el=d("thead",null,[d("tr",null,[d("th",null,"Name"),d("th",{class:"d-none d-md-table-cell"}," Owner "),d("th",null,"Permissions"),d("th")])],-1),ll={class:"d-block d-md-none mt-2"},al=d("strong",null,"Owner",-1),tl=d("br",null,null,-1),ol=d("br",null,null,-1),sl={class:"d-none d-md-table-cell"},nl=d("br",null,null,-1),il=d("br",null,null,-1),ul=d("br",null,null,-1),Ml=J({__name:"GroupsView",emits:["pageTitle"],setup(P,{emit:U}){U("pageTitle","Manage Groups & Permissions");const V=ae(),m=ye(),p=we(),A=v(!1),T=v(),I=v(),r=v([]),a=v([]),f=v([]),N=v(!1),D=v(!1),g=v(!1),b=v(""),i=new URL(location.href).searchParams.get("token")||"",s=l=>{const u=()=>{const o=sessionStorage.getItem("gjt_attempt");let q=Pe.parseInt(o||"0");q<2?(sessionStorage.setItem("gjt_attempt",(q+1).toString()),setTimeout(()=>{location.reload()},2e3)):(sessionStorage.removeItem("gjt_attempt"),localStorage.removeItem("gjt_token"),b.value="There was a problem with this token, it may have expired or already been used.",setTimeout(()=>{p.push("/")},5e3))};V.validateGroupInviteToken(l).then(o=>{o?(Ee(o),localStorage.removeItem("gjt_token"),sessionStorage.setItem("reload","true"),p.push("/")):u()}).catch(()=>{u()})};i!==""?(localStorage.setItem("gjt_token",location.href),s(i)):(A.value=!0,(!m||!m.Groups.find(l=>l.Permission.ManageUsers))&&p.push("/")),Q(T,()=>{$(I.value,T.value)}),Q(I,()=>{$(I.value,T.value)});const n=l=>l.OwnerType===G.OWNER_TYPE_CONVENTION?r.value.filter(u=>u.ConventionUUID===l.OwnerUUID).map(u=>u.Name).join(""):l.OwnerType===G.OWNER_TYPE_ORGANISATION?f.value.filter(u=>u.OrganisationUUID===l.OwnerUUID).map(u=>u.Name).join(""):l.OwnerType===void 0||l.OwnerType===null?"System":"Unknown",_=l=>l.OwnerType===G.OWNER_TYPE_CONVENTION?"Convention":l.OwnerType===G.OWNER_TYPE_ORGANISATION?"Organisation":l.OwnerType===void 0||l.OwnerType===null?"Global":"Unknown",O=()=>{V.getPermissionAccessList(Ne.PERMISSION_TYPE_MANAGE_USERS).then(l=>{r.value=l.Conventions,f.value=l.Organisations}).catch(()=>{})},$=(l=Y,u=Y)=>{V.getManageableGroups(l||Y,u||Y).then(o=>{o&&(a.value=o)}).catch(()=>{})},z=()=>{const l={ID:0,GroupUUID:K(),Type:S.GROUP_TYPE_CONVENTION,Name:"",MinimumNumbers:0,Permission:{ID:0,PermissionUUID:K(),GroupID:0,GroupUUID:K(),EditConvention:!1,EditOrganisation:!1,EditRegistration:!1,ManageUsers:!1,ManageViews:!1,ViewRegistration:!1},Users:[],OwnerID:null,OwnerType:null,OwnerUUID:null};return l.Permission.GroupUUID=l.GroupUUID,l},Z=v(z()),y=v(-1),w=v(z()),ve=ne(()=>y.value===-1?"New Group":"Edit Group"),pe=()=>{Z.value.GroupUUID=K(),w.value=Object.assign({},z()),y.value=-1,N.value=!0},Ue=l=>{y.value=a.value.indexOf(l),w.value=Object.assign({},l),D.value=!0},fe=l=>{y.value=a.value.indexOf(l),w.value=Object.assign({},l),N.value=!0},ce=l=>{y.value=a.value.indexOf(l),w.value=Object.assign({},l),g.value=!0},Ve=()=>{V.deleteGroup(w.value.GroupUUID).then(l=>{l&&(a.value.splice(y.value,1),Ie())})},Oe=()=>{N.value=!1,se(()=>{w.value=Object.assign({},Z.value),y.value=-1})},Ie=()=>{g.value=!1,se(()=>{w.value=Object.assign({},Z.value),y.value=-1})},ge=l=>{y.value>-1?Object.assign(a.value[y.value],l):a.value.push(l),Oe()};return O(),$(I.value,T.value),(l,u)=>(c(),E("div",null,[A.value?(c(),E(F,{key:1},[e(Be,{color:"primary"},{default:t(()=>[e(ee,{label:"Organisation",modelValue:I.value,"onUpdate:modelValue":u[0]||(u[0]=o=>I.value=o),items:f.value,"item-value":"OrganisationUUID","item-title":"Name",clearable:!0,"hide-details":"",class:"mr-1"},null,8,["modelValue","items"]),e(ee,{label:"Convention",modelValue:T.value,"onUpdate:modelValue":u[1]||(u[1]=o=>T.value=o),items:r.value,"item-value":"ConventionUUID","item-title":"Name",clearable:!0,"hide-details":""},null,8,["modelValue","items"]),e(de),e(x,{dark:"",class:"mb-2","prepend-icon":"mdi:mdi-pencil",onClick:pe},{default:t(()=>[M(" New Group ")]),_:1}),e(De,{modelValue:g.value,"onUpdate:modelValue":u[2]||(u[2]=o=>g.value=o),onDelete:Ve},null,8,["modelValue"])]),_:1}),N.value?(c(),k(ze,{key:0,modelValue:N.value,"onUpdate:modelValue":u[3]||(u[3]=o=>N.value=o),group:w.value,"onUpdate:group":u[4]||(u[4]=o=>w.value=o),onSave:ge,title:ve.value,conventions:r.value,organisations:f.value},null,8,["modelValue","group","title","conventions","organisations"])):L("",!0),D.value?(c(),k(Qe,{key:1,modelValue:D.value,"onUpdate:modelValue":u[5]||(u[5]=o=>D.value=o),group:w.value,"onUpdate:group":u[6]||(u[6]=o=>w.value=o),title:`${w.value.Name}`},null,8,["modelValue","group","title"])):L("",!0),e(Fe,null,{default:t(()=>[el,d("tbody",null,[(c(!0),E(F,null,ie(a.value,(o,q)=>(c(),E("tr",{key:o.GroupUUID,class:Te(q%2?"bg-grey-lighten-4":"")},[d("td",null,[M(C(o.Name)+" ",1),d("p",ll,[al,tl,M(" "+C(n(o)),1),ol,d("small",null,"("+C(_(o))+")",1)])]),d("td",sl,[M(C(n(o)),1),nl,d("small",null,"("+C(_(o))+")",1)]),d("td",null,[o.Permission?(c(),k(me,{key:0,modelValue:o.Permission,"onUpdate:modelValue":H=>o.Permission=H,disabled:!0},null,8,["modelValue","onUpdate:modelValue"])):L("",!0)]),d("td",null,[e(x,{icon:"mdi:mdi-account-group",size:"x-small",color:"success",class:"mb-1",onClick:H=>Ue(o)},null,8,["onClick"]),il,o.Type!==X(S).GROUP_TYPE_SYSTEM?(c(),E(F,{key:0},[e(x,{icon:"mdi:mdi-pencil",size:"x-small",color:"primary",class:"mb-1",onClick:H=>fe(o)},null,8,["onClick"]),ul,e(x,{icon:"mdi:mdi-delete",size:"x-small",color:"error",class:"mb-1",onClick:H=>ce(o)},null,8,["onClick"])],64)):L("",!0)])],2))),128))])]),_:1})],64)):(c(),k(We,{key:0,elevation:"2",class:"pa-4"},{default:t(()=>[Xe,b.value?(c(),E("p",Je,C(b.value),1)):L("",!0),b.value?(c(),E("p",Ze,"Please contact your admin and request a new one")):L("",!0)]),_:1}))]))}});export{Ml as default};
