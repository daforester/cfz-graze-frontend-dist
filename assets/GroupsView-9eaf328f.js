import{I as J,a1 as B,a2 as le,K as c,L as k,M as t,v as e,r as v,a3 as F,w as Q,e as ne,S as Z,$ as ae,R as E,H as W,Z as ie,N as M,O as C,U as d,P as _e,a0 as we,Q as L,ar as Te,E as se}from"./index-253b4565.js";import{O as G,G as S}from"./group-d2a77946.js";import{P as Ne}from"./permission-03f04c02.js";import{j as te}from"./VContainer-2c3fed6d.js";import{V as R,a as oe}from"./VRow-d880c4d2.js";import{V as $,u as ue}from"./VCheckbox-ce550f28.js";import{_ as De}from"./DeleteDialog.vue_vue_type_script_setup_true_lang-b8e55e15.js";import{_ as re}from"./ModelDialog.vue_vue_type_script_setup_true_lang-7c3cb2c5.js";import{V as he}from"./VTextField-30c5acee.js";import{V as ee,c as be}from"./copyToClipboard-33e66edd.js";import{u as Y,V as ye}from"./VToolbar-c2875143.js";import{G as Ee,A as Ge}from"./userData-4f6fe910.js";import{u as Re}from"./useAvatar-9a01948d.js";import{_ as Pe,l as Ce}from"./VChip-3c30e7f5.js";import{V as Se,a as ke,d as Me}from"./VList-a6eb26a6.js";import{V as x}from"./VBtn-183aeea4.js";import{V as Ae}from"./VAvatar-f268c0ef.js";import{V as Ye}from"./VDialog-fccd2b18.js";import{e as xe,V as Le,a as $e,c as je,d as Fe}from"./VCard-cefbfc79.js";import{V as de}from"./VSpacer-07ffae07.js";import{a as We,V as Be}from"./VTable-5189de53.js";import{v as K}from"./v4-a960c1f4.js";import"./scopeId-ab681c10.js";import"./useStoreAPI-b9a5486e.js";import"./VDivider-a421d4fb.js";const me=J({__name:"EditGroupPermissions",props:B({disabled:{type:Boolean}},{modelValue:{required:!0}}),emits:["update:modelValue"],setup(P){const U=le(P,"modelValue");return(V,m)=>(c(),k(te,null,{default:t(()=>[e(oe,null,{default:t(()=>[e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e($,{modelValue:U.value.EditConvention,"onUpdate:modelValue":m[0]||(m[0]=p=>U.value.EditConvention=p),label:"Edit Convention","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e($,{modelValue:U.value.EditOrganisation,"onUpdate:modelValue":m[1]||(m[1]=p=>U.value.EditOrganisation=p),label:"Edit Organisation","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e($,{modelValue:U.value.EditRegistration,"onUpdate:modelValue":m[2]||(m[2]=p=>U.value.EditRegistration=p),label:"Edit Registrations","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e($,{modelValue:U.value.ManageUsers,"onUpdate:modelValue":m[3]||(m[3]=p=>U.value.ManageUsers=p),label:"Manage Users","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e($,{modelValue:U.value.ManageViews,"onUpdate:modelValue":m[4]||(m[4]=p=>U.value.ManageViews=p),label:"Manage Views","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1}),e(R,{cols:"12",sm:"6",md:"4"},{default:t(()=>[e($,{modelValue:U.value.ViewRegistration,"onUpdate:modelValue":m[5]||(m[5]=p=>U.value.ViewRegistration=p),label:"View Registrations","hide-details":"",disabled:V.disabled},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}))}}),ze=J({__name:"EditGroupDialog",props:B({conventions:{},organisations:{},group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:B(["update:group","save"],["update:modelValue"]),setup(P,{emit:U}){const V=P,m=ae(),{conventions:p,organisations:A,title:T=""}=V,I=le(P,"modelValue"),r=ue(V,U,void 0,void 0,"group"),a=v(F(r.value)),f=v(null);a.value.OwnerType===G.OWNER_TYPE_CONVENTION?f.value=p.filter(i=>i.ConventionUUID==a.value.OwnerUUID).map(i=>i.ConventionUUID).join(""):a.value.OwnerType===G.OWNER_TYPE_ORGANISATION?f.value=A.filter(i=>i.OrganisationUUID==a.value.OwnerUUID).map(i=>i.OrganisationUUID).join(""):(a.value.Type===S.GROUP_TYPE_SYSTEM||a.value.Type===S.GROUP_TYPE_ADMIN)&&(f.value=null),Q(r,()=>{a.value=F(r.value)});const N=v({ID:0,PermissionUUID:Y,GroupID:0,GroupUUID:Y,EditConvention:!1,EditOrganisation:!1,EditRegistration:!1,ViewRegistration:!1,ManageUsers:!1,ManageViews:!1});m.getPermission(S.GROUP_TYPE_SYSTEM,Y).then(i=>{N.value=i,b()}).catch(()=>{});const D=()=>{a.value=F(r.value),b()},g=i=>{if(f.value==null)a.value.Type=S.GROUP_TYPE_ADMIN,a.value.OwnerType=null,a.value.OwnerID=null,a.value.OwnerUUID=null;else{const s=h.value.find(n=>f.value===n.OwnerUUID);s&&(s.OwnerType==G.OWNER_TYPE_ORGANISATION?a.value.Type=S.GROUP_TYPE_ORGANISATION:s.OwnerType==G.OWNER_TYPE_CONVENTION&&(a.value.Type=S.GROUP_TYPE_CONVENTION),a.value.OwnerType=s.OwnerType,a.value.OwnerID=s.OwnerID,a.value.OwnerUUID=s.OwnerUUID)}m.saveGroup(a.value).then(s=>{s&&i&&i("Group Saved").then(()=>{r.value=s,U("save",s)})}).catch(()=>{i&&i("Failed to Save Group")})},b=()=>{const i=h.value.find(s=>a.value.OwnerUUID===s.OwnerUUID);i?f.value=i.OwnerUUID:h.value.length>0&&(f.value=null)},h=ne(()=>{const i=[];return N.value.ManageUsers&&i.push({Label:"System Admin",OwnerID:null,OwnerUUID:null,OwnerType:null}),i.push(...p.map(s=>({Label:`${s.Name} (Convention)`,OwnerID:s.ID,OwnerUUID:s.ConventionUUID,OwnerType:G.OWNER_TYPE_CONVENTION}))),i.push(...A.map(s=>({Label:`${s.Name} (Organisation)`,OwnerID:s.ID,OwnerUUID:s.OrganisationUUID,OwnerType:G.OWNER_TYPE_ORGANISATION}))),i});return b(),(i,s)=>(c(),k(re,{modelValue:I.value,"onUpdate:modelValue":s[3]||(s[3]=n=>I.value=n),onReset:D,onSave:g,title:Z(T),color:"primary","show-close-action":!0,"show-reset-action":!0,"show-save-action":!0},{default:t(()=>[e(te,{class:"pa-0",fluid:!0},{default:t(()=>[e(oe,null,{default:t(()=>[e(R,{cols:"12",md:"6"},{default:t(()=>[e(he,{modelValue:a.value.Name,"onUpdate:modelValue":s[0]||(s[0]=n=>a.value.Name=n),label:"Name",variant:"outlined"},null,8,["modelValue"])]),_:1}),e(R,{cols:"12",md:"6"},{default:t(()=>[e(ee,{modelValue:f.value,"onUpdate:modelValue":s[1]||(s[1]=n=>f.value=n),label:"Owner",items:h.value,"item-title":"Label","item-value":"OwnerUUID",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),e(R,{cols:"12"},{default:t(()=>[e(me,{modelValue:a.value.Permission,"onUpdate:modelValue":s[2]||(s[2]=n=>a.value.Permission=n),disabled:!1},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"]))}}),qe=d("p",null," Are you sure you wish to remove this user? If they have permissions from another group these will still be usable. To add the user back into the group you may need to provide them with a new invite link. ",-1),He={key:1},Ke=["href","onClick"],Qe=J({__name:"EditGroupMembersDialog",props:B({group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:B(["update:group","save"],["update:modelValue"]),setup(P,{emit:U}){const V=P,m=ae(),p=Re(),{title:A=""}=V,T=le(P,"modelValue"),I=ue(V,U,void 0,void 0,"group"),r=v(F(I.value));(r.value.Users==null||r.value.Users.length==0)&&m.getGroupMembers(r.value.GroupUUID).then(n=>{n&&(r.value.Users=n)}).catch(()=>{r.value.Users=[]});const a=v(""),f=()=>{m.getGroupInvite(r.value.GroupUUID).then(n=>{if(n){const _=new URL(location.href);_.searchParams.set("token",n),a.value=_.toString()}})};f(),Q(I,()=>{r.value=F(I.value)});const N=()=>{be(a.value),f()},D=v(!1),g=v(-1),b=v(""),h=()=>{g.value=-1,D.value=!1},i=n=>{g.value=n,D.value=!0},s=({callback:n})=>{if(!r.value.Users){n&&(n("Failed to Remove User"),setTimeout(h,2e3));return}b.value="",g.value<0||g.value>=r.value.Users.length?(n&&n("Invalid Convention"),setTimeout(h,2e3)):m.removeUserFromGroup(r.value.Users[g.value].UserUUID,r.value.GroupUUID).then(_=>{var O;_?((O=r.value.Users)==null||O.splice(g.value,1),n&&n("User Removed")):n&&n("Failed to Remove User"),setTimeout(h,2e3)}).catch(()=>{n&&(n("Failed to Remove User"),setTimeout(h,2e3))})};return(n,_)=>(c(),k(re,{modelValue:T.value,"onUpdate:modelValue":_[1]||(_[1]=O=>T.value=O),title:Z(A),color:"primary"},{default:t(()=>[e(te,{class:"pa-0",fluid:!0},{default:t(()=>[r.value.Users&&r.value.Users.length?(c(),E(W,{key:0},[e(Se,null,{default:t(()=>[(c(!0),E(W,null,ie(r.value.Users,(O,j)=>(c(),k(ke,{key:O.UserUUID},{append:t(()=>[e(x,{color:"red-darken-3",icon:"mdi:mdi-window-close",size:"x-small",onClick:z=>i(j)},null,8,["onClick"])]),prepend:t(()=>[e(Ae,{src:Z(p)(O.UserUUID),class:"rounded-circle mr-2",height:"32",width:"32"},null,8,["src"])]),default:t(()=>[e(Me,null,{default:t(()=>[M(C(O.DisplayName)+" "+C(O.Handle?`(${O.Handle})`:""),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(Ye,{modelValue:D.value,"onUpdate:modelValue":_[0]||(_[0]=O=>D.value=O),width:"auto"},{default:t(()=>[e(xe,null,{default:t(()=>[e(Le,null,{default:t(()=>[M(" Remove User from Group ")]),_:1}),e($e,null,{default:t(()=>[M(" User will no longer have the permissions from this group. ")]),_:1}),e(je,null,{default:t(()=>[e(oe,null,{default:t(()=>[e(R,null,{default:t(()=>[qe]),_:1})]),_:1})]),_:1}),e(Fe,null,{default:t(()=>[e(x,{color:"primary",onClick:h},{default:t(()=>[M("Cancel")]),_:1}),e(de),e(Pe,{color:"red-darken-3",label:"Remove User",onClick:s})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)):(c(),E("p",He," No members "))]),_:1})]),actions:t(()=>[e(x,{variant:"text"},{default:t(()=>[d("a",{href:a.value,onClick:_e(N,["prevent"])},"Invite URL",8,Ke)]),_:1})]),_:1},8,["modelValue","title"]))}}),Ze=d("h1",{class:"text-center mt-5"},"Processing Invite...",-1),Je={key:0,class:"text-center mt-5 text-red text-h5"},Xe={key:1,class:"text-center mt-5"},el=d("thead",null,[d("tr",null,[d("th",null,"Name"),d("th",{class:"d-none d-md-table-cell"}," Owner "),d("th",null,"Permissions"),d("th")])],-1),ll={class:"d-block d-md-none mt-2"},al=d("strong",null,"Owner",-1),tl=d("br",null,null,-1),ol=d("br",null,null,-1),sl={class:"d-none d-md-table-cell"},nl=d("br",null,null,-1),il=d("br",null,null,-1),ul=d("br",null,null,-1),Sl=J({__name:"GroupsView",emits:["pageTitle"],setup(P,{emit:U}){U("pageTitle","Manage Groups & Permissions");const V=ae(),m=Ee(),p=we(),A=v(!1),T=v(),I=v(),r=v([]),a=v([]),f=v([]),N=v(!1),D=v(!1),g=v(!1),b=v(""),i=new URL(location.href).searchParams.get("token")||"",s=l=>{const u=()=>{const o=sessionStorage.getItem("gjt_attempt");let q=Ce.parseInt(o||"0");q<2?(sessionStorage.setItem("gjt_attempt",(q+1).toString()),setTimeout(()=>{location.reload()},2e3)):(sessionStorage.removeItem("gjt_attempt"),localStorage.removeItem("gjt_token"),b.value="There was a problem with this token, it may have expired or already been used.",setTimeout(()=>{p.push("/")},5e3))};V.validateGroupInviteToken(l).then(o=>{o?(Ge(o),localStorage.removeItem("gjt_token"),sessionStorage.setItem("reload","true"),p.push("/")):u()}).catch(()=>{u()})};i!==""?(localStorage.setItem("gjt_token",location.href),s(i)):(A.value=!0,(!m||!m.Groups.find(l=>l.Permission.ManageUsers))&&p.push("/")),Q(T,()=>{j(I.value,T.value)}),Q(I,()=>{j(I.value,T.value)});const n=l=>l.OwnerType===G.OWNER_TYPE_CONVENTION?r.value.filter(u=>u.ConventionUUID===l.OwnerUUID).map(u=>u.Name).join(""):l.OwnerType===G.OWNER_TYPE_ORGANISATION?f.value.filter(u=>u.OrganisationUUID===l.OwnerUUID).map(u=>u.Name).join(""):l.OwnerType===void 0||l.OwnerType===null?"System":"Unknown",_=l=>l.OwnerType===G.OWNER_TYPE_CONVENTION?"Convention":l.OwnerType===G.OWNER_TYPE_ORGANISATION?"Organisation":l.OwnerType===void 0||l.OwnerType===null?"Global":"Unknown",O=()=>{V.getPermissionAccessList(Ne.PERMISSION_TYPE_MANAGE_USERS).then(l=>{r.value=l.Conventions,f.value=l.Organisations}).catch(()=>{})},j=(l=Y,u=Y)=>{V.getManageableGroups(l||Y,u||Y).then(o=>{o&&(a.value=o)}).catch(()=>{})},z=()=>{const l={ID:0,GroupUUID:K(),Type:S.GROUP_TYPE_CONVENTION,Name:"",MinimumNumbers:0,Permission:{ID:0,PermissionUUID:K(),GroupID:0,GroupUUID:K(),EditConvention:!1,EditOrganisation:!1,EditRegistration:!1,ManageUsers:!1,ManageViews:!1,ViewRegistration:!1},Users:[],OwnerID:null,OwnerType:null,OwnerUUID:null};return l.Permission.GroupUUID=l.GroupUUID,l},X=v(z()),y=v(-1),w=v(z()),ve=ne(()=>y.value===-1?"New Group":"Edit Group"),pe=()=>{X.value.GroupUUID=K(),w.value=Object.assign({},z()),y.value=-1,N.value=!0},Ue=l=>{y.value=a.value.indexOf(l),w.value=Object.assign({},l),D.value=!0},fe=l=>{y.value=a.value.indexOf(l),w.value=Object.assign({},l),N.value=!0},ce=l=>{y.value=a.value.indexOf(l),w.value=Object.assign({},l),g.value=!0},Ve=()=>{V.deleteGroup(w.value.GroupUUID).then(l=>{l&&(a.value.splice(y.value,1),Ie())})},Oe=()=>{N.value=!1,se(()=>{w.value=Object.assign({},X.value),y.value=-1})},Ie=()=>{g.value=!1,se(()=>{w.value=Object.assign({},X.value),y.value=-1})},ge=l=>{y.value>-1?Object.assign(a.value[y.value],l):a.value.push(l),Oe()};return O(),j(I.value,T.value),(l,u)=>(c(),E("div",null,[A.value?(c(),E(W,{key:1},[e(ye,{color:"primary"},{default:t(()=>[e(ee,{label:"Organisation",modelValue:I.value,"onUpdate:modelValue":u[0]||(u[0]=o=>I.value=o),items:f.value,"item-value":"OrganisationUUID","item-title":"Name",clearable:!0,"hide-details":"",class:"mr-1"},null,8,["modelValue","items"]),e(ee,{label:"Convention",modelValue:T.value,"onUpdate:modelValue":u[1]||(u[1]=o=>T.value=o),items:r.value,"item-value":"ConventionUUID","item-title":"Name",clearable:!0,"hide-details":""},null,8,["modelValue","items"]),e(de),e(x,{dark:"",class:"mb-2","prepend-icon":"mdi:mdi-pencil",onClick:pe},{default:t(()=>[M(" New Group ")]),_:1}),e(De,{modelValue:g.value,"onUpdate:modelValue":u[2]||(u[2]=o=>g.value=o),onDelete:Ve},null,8,["modelValue"])]),_:1}),N.value?(c(),k(ze,{key:0,modelValue:N.value,"onUpdate:modelValue":u[3]||(u[3]=o=>N.value=o),group:w.value,"onUpdate:group":u[4]||(u[4]=o=>w.value=o),onSave:ge,title:ve.value,conventions:r.value,organisations:f.value},null,8,["modelValue","group","title","conventions","organisations"])):L("",!0),D.value?(c(),k(Qe,{key:1,modelValue:D.value,"onUpdate:modelValue":u[5]||(u[5]=o=>D.value=o),group:w.value,"onUpdate:group":u[6]||(u[6]=o=>w.value=o),title:`${w.value.Name}`},null,8,["modelValue","group","title"])):L("",!0),e(Be,null,{default:t(()=>[el,d("tbody",null,[(c(!0),E(W,null,ie(a.value,(o,q)=>(c(),E("tr",{key:o.GroupUUID,class:Te(q%2?"bg-grey-lighten-4":"")},[d("td",null,[M(C(o.Name)+" ",1),d("p",ll,[al,tl,M(" "+C(n(o)),1),ol,d("small",null,"("+C(_(o))+")",1)])]),d("td",sl,[M(C(n(o)),1),nl,d("small",null,"("+C(_(o))+")",1)]),d("td",null,[o.Permission?(c(),k(me,{key:0,modelValue:o.Permission,"onUpdate:modelValue":H=>o.Permission=H,disabled:!0},null,8,["modelValue","onUpdate:modelValue"])):L("",!0)]),d("td",null,[e(x,{icon:"mdi:mdi-account-group",size:"x-small",color:"success",class:"mb-1",onClick:H=>Ue(o)},null,8,["onClick"]),il,o.Type!==Z(S).GROUP_TYPE_SYSTEM?(c(),E(W,{key:0},[e(x,{icon:"mdi:mdi-pencil",size:"x-small",color:"primary",class:"mb-1",onClick:H=>fe(o)},null,8,["onClick"]),ul,e(x,{icon:"mdi:mdi-delete",size:"x-small",color:"error",class:"mb-1",onClick:H=>ce(o)},null,8,["onClick"])],64)):L("",!0)])],2))),128))])]),_:1})],64)):(c(),k(We,{key:0,elevation:"2",class:"pa-4"},{default:t(()=>[Ze,b.value?(c(),E("p",Je,C(b.value),1)):L("",!0),b.value?(c(),E("p",Xe,"Please contact your admin and request a new one")):L("",!0)]),_:1}))]))}});export{Sl as default};
