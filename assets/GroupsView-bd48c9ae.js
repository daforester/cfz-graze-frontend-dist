import{I as J,a1 as B,a2 as le,K as O,L,M as o,v as e,r as v,a3 as W,w as Q,e as ne,S as Z,$ as ae,R as y,H as $,Z as ie,N as S,O as C,U as d,P as _e,a0 as we,Q as F,ar as Te,E as se}from"./index-4f5d8caf.js";import{O as h,G as M}from"./group-d2a77946.js";import{P as Ne}from"./permission-03f04c02.js";import{j as te}from"./VContainer-31f0b3d6.js";import{V as G,a as oe}from"./VRow-23fcc6e5.js";import{V as x,u as ue}from"./VCheckbox-9d30a3de.js";import{_ as De}from"./DeleteDialog.vue_vue_type_script_setup_true_lang-ef2e899c.js";import{_ as re}from"./ModelDialog.vue_vue_type_script_setup_true_lang-bbc7576b.js";import{V as Ee}from"./VTextField-8f3a72eb.js";import{V as ee,c as be}from"./copyToClipboard-055c720e.js";import{u as A,V as ye}from"./VToolbar-e844a699.js";import{G as he,A as Ge}from"./userData-74c9686e.js";import{u as Re}from"./useAvatar-b7d00a9d.js";import{_ as Pe,l as Ce}from"./VChip-8d70d89c.js";import{V as Me,a as Se,d as ke}from"./VList-c41b646d.js";import{V as Y}from"./VBtn-f35f5ea5.js";import{V as Ae}from"./VAvatar-810dec4f.js";import{V as Ye}from"./VDialog-e5db1bab.js";import{e as Le,V as xe,a as $e,c as je,d as Fe}from"./VCard-a7b6884d.js";import{V as de}from"./VSpacer-e507c4fe.js";import{V as We}from"./VTable-ec73514b.js";import{v as K}from"./v4-a960c1f4.js";import"./scopeId-16b905ed.js";import"./useStoreAPI-deac32fc.js";import"./VDivider-7d1b6910.js";const me=J({__name:"EditGroupPermissions",props:B({disabled:{type:Boolean}},{modelValue:{required:!0}}),emits:["update:modelValue"],setup(R){const U=le(R,"modelValue");return(c,m)=>(O(),L(te,null,{default:o(()=>[e(oe,null,{default:o(()=>[e(G,{cols:"12",sm:"6",md:"4"},{default:o(()=>[e(x,{modelValue:U.value.EditConvention,"onUpdate:modelValue":m[0]||(m[0]=p=>U.value.EditConvention=p),label:"Edit Convention","hide-details":"",disabled:c.disabled},null,8,["modelValue","disabled"])]),_:1}),e(G,{cols:"12",sm:"6",md:"4"},{default:o(()=>[e(x,{modelValue:U.value.EditOrganisation,"onUpdate:modelValue":m[1]||(m[1]=p=>U.value.EditOrganisation=p),label:"Edit Organisation","hide-details":"",disabled:c.disabled},null,8,["modelValue","disabled"])]),_:1}),e(G,{cols:"12",sm:"6",md:"4"},{default:o(()=>[e(x,{modelValue:U.value.EditRegistration,"onUpdate:modelValue":m[2]||(m[2]=p=>U.value.EditRegistration=p),label:"Edit Registrations","hide-details":"",disabled:c.disabled},null,8,["modelValue","disabled"])]),_:1}),e(G,{cols:"12",sm:"6",md:"4"},{default:o(()=>[e(x,{modelValue:U.value.ManageUsers,"onUpdate:modelValue":m[3]||(m[3]=p=>U.value.ManageUsers=p),label:"Manage Users","hide-details":"",disabled:c.disabled},null,8,["modelValue","disabled"])]),_:1}),e(G,{cols:"12",sm:"6",md:"4"},{default:o(()=>[e(x,{modelValue:U.value.ManageViews,"onUpdate:modelValue":m[4]||(m[4]=p=>U.value.ManageViews=p),label:"Manage Views","hide-details":"",disabled:c.disabled},null,8,["modelValue","disabled"])]),_:1}),e(G,{cols:"12",sm:"6",md:"4"},{default:o(()=>[e(x,{modelValue:U.value.ViewRegistration,"onUpdate:modelValue":m[5]||(m[5]=p=>U.value.ViewRegistration=p),label:"View Registrations","hide-details":"",disabled:c.disabled},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}))}}),Be=J({__name:"EditGroupDialog",props:B({conventions:{},organisations:{},group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:B(["update:group","save"],["update:modelValue"]),setup(R,{emit:U}){const c=R,m=ae(),{conventions:p,organisations:k,title:T=""}=c,I=le(R,"modelValue"),r=ue(c,U,void 0,void 0,"group"),a=v(W(r.value)),f=v(null);a.value.OwnerType===h.OWNER_TYPE_CONVENTION?f.value=p.filter(i=>i.ConventionUUID==a.value.OwnerUUID).map(i=>i.ConventionUUID).join(""):a.value.OwnerType===h.OWNER_TYPE_ORGANISATION?f.value=k.filter(i=>i.OrganisationUUID==a.value.OwnerUUID).map(i=>i.OrganisationUUID).join(""):(a.value.Type===M.GROUP_TYPE_SYSTEM||a.value.Type===M.GROUP_TYPE_ADMIN)&&(f.value=null),Q(r,()=>{a.value=W(r.value)});const N=v({ID:0,PermissionUUID:A,GroupID:0,GroupUUID:A,EditConvention:!1,EditOrganisation:!1,EditRegistration:!1,ViewRegistration:!1,ManageUsers:!1,ManageViews:!1});m.getPermission(M.GROUP_TYPE_SYSTEM,A).then(i=>{N.value=i,P()}).catch(()=>{});const D=()=>{a.value=W(r.value),P()},g=i=>{if(f.value==null)a.value.Type=M.GROUP_TYPE_ADMIN,a.value.OwnerType=null,a.value.OwnerID=null,a.value.OwnerUUID=null;else{const s=E.value.find(n=>f.value===n.OwnerUUID);s&&(s.OwnerType==h.OWNER_TYPE_ORGANISATION?a.value.Type=M.GROUP_TYPE_ORGANISATION:s.OwnerType==h.OWNER_TYPE_CONVENTION&&(a.value.Type=M.GROUP_TYPE_CONVENTION),a.value.OwnerType=s.OwnerType,a.value.OwnerID=s.OwnerID,a.value.OwnerUUID=s.OwnerUUID)}m.saveGroup(a.value).then(s=>{s&&i&&i("Group Saved").then(()=>{r.value=s,U("save",s)})}).catch(()=>{i&&i("Failed to Save Group")})},P=()=>{const i=E.value.find(s=>a.value.OwnerUUID===s.OwnerUUID);i?f.value=i.OwnerUUID:E.value.length>0&&(f.value=null)},E=ne(()=>{const i=[];return N.value.ManageUsers&&i.push({Label:"System Admin",OwnerID:null,OwnerUUID:null,OwnerType:null}),i.push(...p.map(s=>({Label:`${s.Name} (Convention)`,OwnerID:s.ID,OwnerUUID:s.ConventionUUID,OwnerType:h.OWNER_TYPE_CONVENTION}))),i.push(...k.map(s=>({Label:`${s.Name} (Organisation)`,OwnerID:s.ID,OwnerUUID:s.OrganisationUUID,OwnerType:h.OWNER_TYPE_ORGANISATION}))),i});return P(),(i,s)=>(O(),L(re,{modelValue:I.value,"onUpdate:modelValue":s[3]||(s[3]=n=>I.value=n),onReset:D,onSave:g,title:Z(T),color:"primary","show-close-action":!0,"show-reset-action":!0,"show-save-action":!0},{default:o(()=>[e(te,{class:"pa-0",fluid:!0},{default:o(()=>[e(oe,null,{default:o(()=>[e(G,{cols:"12",md:"6"},{default:o(()=>[e(Ee,{modelValue:a.value.Name,"onUpdate:modelValue":s[0]||(s[0]=n=>a.value.Name=n),label:"Name",variant:"outlined"},null,8,["modelValue"])]),_:1}),e(G,{cols:"12",md:"6"},{default:o(()=>[e(ee,{modelValue:f.value,"onUpdate:modelValue":s[1]||(s[1]=n=>f.value=n),label:"Owner",items:E.value,"item-title":"Label","item-value":"OwnerUUID",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),e(G,{cols:"12"},{default:o(()=>[e(me,{modelValue:a.value.Permission,"onUpdate:modelValue":s[2]||(s[2]=n=>a.value.Permission=n),disabled:!1},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"]))}}),ze=d("p",null," Are you sure you wish to remove this user? If they have permissions from another group these will still be usable. To add the user back into the group you may need to provide them with a new invite link. ",-1),qe={key:1},He=["href","onClick"],Ke=J({__name:"EditGroupMembersDialog",props:B({group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:B(["update:group","save"],["update:modelValue"]),setup(R,{emit:U}){const c=R,m=ae(),p=Re(),{title:k=""}=c,T=le(R,"modelValue"),I=ue(c,U,void 0,void 0,"group"),r=v(W(I.value));(r.value.Users==null||r.value.Users.length==0)&&m.getGroupMembers(r.value.GroupUUID).then(n=>{n&&(r.value.Users=n)}).catch(()=>{r.value.Users=[]});const a=v(""),f=()=>{m.getGroupInvite(r.value.GroupUUID).then(n=>{if(n){const _=new URL(location.href);_.searchParams.set("token",n),a.value=_.toString()}})};f(),Q(I,()=>{r.value=W(I.value)});const N=()=>{be(a.value),f()},D=v(!1),g=v(-1),P=v(""),E=()=>{g.value=-1,D.value=!1},i=n=>{g.value=n,D.value=!0},s=({callback:n})=>{if(!r.value.Users){n&&(n("Failed to Remove User"),setTimeout(E,2e3));return}P.value="",g.value<0||g.value>=r.value.Users.length?(n&&n("Invalid Convention"),setTimeout(E,2e3)):m.removeUserFromGroup(r.value.Users[g.value].UserUUID,r.value.GroupUUID).then(_=>{var V;_?((V=r.value.Users)==null||V.splice(g.value,1),n&&n("User Removed")):n&&n("Failed to Remove User"),setTimeout(E,2e3)}).catch(()=>{n&&(n("Failed to Remove User"),setTimeout(E,2e3))})};return(n,_)=>(O(),L(re,{modelValue:T.value,"onUpdate:modelValue":_[1]||(_[1]=V=>T.value=V),title:Z(k),color:"primary"},{default:o(()=>[e(te,{class:"pa-0",fluid:!0},{default:o(()=>[r.value.Users&&r.value.Users.length?(O(),y($,{key:0},[e(Me,null,{default:o(()=>[(O(!0),y($,null,ie(r.value.Users,(V,j)=>(O(),L(Se,{key:V.UserUUID},{append:o(()=>[e(Y,{color:"red-darken-3",icon:"mdi:mdi-window-close",size:"x-small",onClick:z=>i(j)},null,8,["onClick"])]),prepend:o(()=>[e(Ae,{src:Z(p)(V.UserUUID),class:"rounded-circle mr-2",height:"32",width:"32"},null,8,["src"])]),default:o(()=>[e(ke,null,{default:o(()=>[S(C(V.DisplayName)+" "+C(V.Handle?`(${V.Handle})`:""),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(Ye,{modelValue:D.value,"onUpdate:modelValue":_[0]||(_[0]=V=>D.value=V),width:"auto"},{default:o(()=>[e(Le,null,{default:o(()=>[e(xe,null,{default:o(()=>[S(" Remove User from Group ")]),_:1}),e($e,null,{default:o(()=>[S(" User will no longer have the permissions from this group. ")]),_:1}),e(je,null,{default:o(()=>[e(oe,null,{default:o(()=>[e(G,null,{default:o(()=>[ze]),_:1})]),_:1})]),_:1}),e(Fe,null,{default:o(()=>[e(Y,{color:"primary",onClick:E},{default:o(()=>[S("Cancel")]),_:1}),e(de),e(Pe,{color:"red-darken-3",label:"Remove User",onClick:s})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)):(O(),y("p",qe," No members "))]),_:1})]),actions:o(()=>[e(Y,{variant:"text"},{default:o(()=>[d("a",{href:a.value,onClick:_e(N,["prevent"])},"Invite URL",8,He)]),_:1})]),_:1},8,["modelValue","title"]))}}),Qe=d("h1",{class:"text-center mt-5"},"Processing Invite...",-1),Ze={key:0,class:"text-center mt-5 text-red text-h5"},Je=d("p",{class:"text-center mt-5"},"Please contact your admin and request a new one",-1),Xe=d("thead",null,[d("tr",null,[d("th",null,"Name"),d("th",{class:"d-none d-md-table-cell"}," Owner "),d("th",null,"Permissions"),d("th")])],-1),el={class:"d-block d-md-none mt-2"},ll=d("strong",null,"Owner",-1),al=d("br",null,null,-1),tl=d("br",null,null,-1),ol={class:"d-none d-md-table-cell"},sl=d("br",null,null,-1),nl=d("br",null,null,-1),il=d("br",null,null,-1),Cl=J({__name:"GroupsView",emits:["pageTitle"],setup(R,{emit:U}){U("pageTitle","Manage Groups & Permissions");const c=ae(),m=he(),p=we();(!m||!m.Groups.find(l=>l.Permission.ManageUsers))&&p.push("/");const k=v(!1),T=v(),I=v(),r=v([]),a=v([]),f=v([]),N=v(!1),D=v(!1),g=v(!1),P=v(""),i=new URL(location.href).searchParams.get("token")||"";i!==""?(l=>{const u=()=>{const t=sessionStorage.getItem("gjt_attempt");let q=Ce.parseInt(t||"0");q<2?(sessionStorage.setItem("gjt_attempt",(q+1).toString()),setTimeout(()=>{location.reload()},1e3)):(sessionStorage.removeItem("gjt_attempt"),p.push("/"))};c.validateGroupInviteToken(l).then(t=>{t?(Ge(t),sessionStorage.setItem("reload","true"),p.push("/")):u()}).catch(()=>{u()})})(i):k.value=!0,Q(T,()=>{j(I.value,T.value)}),Q(I,()=>{j(I.value,T.value)});const n=l=>l.OwnerType===h.OWNER_TYPE_CONVENTION?r.value.filter(u=>u.ConventionUUID===l.OwnerUUID).map(u=>u.Name).join(""):l.OwnerType===h.OWNER_TYPE_ORGANISATION?f.value.filter(u=>u.OrganisationUUID===l.OwnerUUID).map(u=>u.Name).join(""):l.OwnerType===void 0||l.OwnerType===null?"System":"Unknown",_=l=>l.OwnerType===h.OWNER_TYPE_CONVENTION?"Convention":l.OwnerType===h.OWNER_TYPE_ORGANISATION?"Organisation":l.OwnerType===void 0||l.OwnerType===null?"Global":"Unknown",V=()=>{c.getPermissionAccessList(Ne.PERMISSION_TYPE_MANAGE_USERS).then(l=>{r.value=l.Conventions,f.value=l.Organisations}).catch(()=>{})},j=(l=A,u=A)=>{c.getManageableGroups(l||A,u||A).then(t=>{t&&(a.value=t)}).catch(()=>{})},z=()=>{const l={ID:0,GroupUUID:K(),Type:M.GROUP_TYPE_CONVENTION,Name:"",MinimumNumbers:0,Permission:{ID:0,PermissionUUID:K(),GroupID:0,GroupUUID:K(),EditConvention:!1,EditOrganisation:!1,EditRegistration:!1,ManageUsers:!1,ManageViews:!1,ViewRegistration:!1},Users:[],OwnerID:null,OwnerType:null,OwnerUUID:null};return l.Permission.GroupUUID=l.GroupUUID,l},X=v(z()),b=v(-1),w=v(z()),ve=ne(()=>b.value===-1?"New Group":"Edit Group"),pe=()=>{X.value.GroupUUID=K(),w.value=Object.assign({},z()),b.value=-1,N.value=!0},Ue=l=>{b.value=a.value.indexOf(l),w.value=Object.assign({},l),D.value=!0},fe=l=>{b.value=a.value.indexOf(l),w.value=Object.assign({},l),N.value=!0},ce=l=>{b.value=a.value.indexOf(l),w.value=Object.assign({},l),g.value=!0},Oe=()=>{c.deleteGroup(w.value.GroupUUID).then(l=>{l&&(a.value.splice(b.value,1),Ie())})},Ve=()=>{N.value=!1,se(()=>{w.value=Object.assign({},X.value),b.value=-1})},Ie=()=>{g.value=!1,se(()=>{w.value=Object.assign({},X.value),b.value=-1})},ge=l=>{b.value>-1?Object.assign(a.value[b.value],l):a.value.push(l),Ve()};return V(),j(I.value,T.value),(l,u)=>(O(),y("div",null,[k.value?(O(),y($,{key:1},[e(ye,{color:"primary"},{default:o(()=>[e(ee,{label:"Organisation",modelValue:I.value,"onUpdate:modelValue":u[0]||(u[0]=t=>I.value=t),items:f.value,"item-value":"OrganisationUUID","item-title":"Name",clearable:!0,"hide-details":"",class:"mr-1"},null,8,["modelValue","items"]),e(ee,{label:"Convention",modelValue:T.value,"onUpdate:modelValue":u[1]||(u[1]=t=>T.value=t),items:r.value,"item-value":"ConventionUUID","item-title":"Name",clearable:!0,"hide-details":""},null,8,["modelValue","items"]),e(de),e(Y,{dark:"",class:"mb-2","prepend-icon":"mdi:mdi-pencil",onClick:pe},{default:o(()=>[S(" New Group ")]),_:1}),e(De,{modelValue:g.value,"onUpdate:modelValue":u[2]||(u[2]=t=>g.value=t),onDelete:Oe},null,8,["modelValue"])]),_:1}),N.value?(O(),L(Be,{key:0,modelValue:N.value,"onUpdate:modelValue":u[3]||(u[3]=t=>N.value=t),group:w.value,"onUpdate:group":u[4]||(u[4]=t=>w.value=t),onSave:ge,title:ve.value,conventions:r.value,organisations:f.value},null,8,["modelValue","group","title","conventions","organisations"])):F("",!0),D.value?(O(),L(Ke,{key:1,modelValue:D.value,"onUpdate:modelValue":u[5]||(u[5]=t=>D.value=t),group:w.value,"onUpdate:group":u[6]||(u[6]=t=>w.value=t),title:`${w.value.Name}`},null,8,["modelValue","group","title"])):F("",!0),e(We,null,{default:o(()=>[Xe,d("tbody",null,[(O(!0),y($,null,ie(a.value,(t,q)=>(O(),y("tr",{key:t.GroupUUID,class:Te(q%2?"bg-grey-lighten-4":"")},[d("td",null,[S(C(t.Name)+" ",1),d("p",el,[ll,al,S(" "+C(n(t)),1),tl,d("small",null,"("+C(_(t))+")",1)])]),d("td",ol,[S(C(n(t)),1),sl,d("small",null,"("+C(_(t))+")",1)]),d("td",null,[t.Permission?(O(),L(me,{key:0,modelValue:t.Permission,"onUpdate:modelValue":H=>t.Permission=H,disabled:!0},null,8,["modelValue","onUpdate:modelValue"])):F("",!0)]),d("td",null,[e(Y,{icon:"mdi:mdi-account-group",size:"x-small",color:"success",class:"mb-1",onClick:H=>Ue(t)},null,8,["onClick"]),nl,t.Type!==Z(M).GROUP_TYPE_SYSTEM?(O(),y($,{key:0},[e(Y,{icon:"mdi:mdi-pencil",size:"x-small",color:"primary",class:"mb-1",onClick:H=>fe(t)},null,8,["onClick"]),il,e(Y,{icon:"mdi:mdi-delete",size:"x-small",color:"error",class:"mb-1",onClick:H=>ce(t)},null,8,["onClick"])],64)):F("",!0)])],2))),128))])]),_:1})],64)):(O(),y($,{key:0},[Qe,P.value?(O(),y("p",Ze,C(P.value),1)):F("",!0),Je],64))]))}});export{Cl as default};
