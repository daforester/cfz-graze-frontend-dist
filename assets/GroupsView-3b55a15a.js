import{u as Q}from"./useGrazeAPI-837849d5.js";import{V as X}from"./VContainer-cc9b11bd.js";import{V as S,a as ee}from"./VRow-bdb2d614.js";import{V as k,u as te}from"./VCheckbox-3d59ac07.js";import{d as Z,Y as j,Z as le,o as E,b as L,w as o,c as l,y as p,S as $,k as q,h as oe,M as H,O as G,F as x,P as ne,e as M,G as Y,f as m,H as ce,D as Ne,L as J,aq as Ve,z as ae}from"./index-162d4367.js";import{_ as se,a as Te}from"./ModelDialog.vue_vue_type_script_setup_true_lang-f67fcb74.js";import{V as ge}from"./VTextField-745142c2.js";import{V as K}from"./VSelect-f8a615c2.js";import{u as A}from"./nil-d01db1aa.js";import{G as Re,A as Pe}from"./userData-887aea4a.js";import{u as we}from"./useAvatar-782f434f.js";import{_ as Se}from"./SaveButton.vue_vue_type_script_setup_true_lang-8a0fe26a.js";import{V as De,a as Ge,c as be}from"./VList-acae746e.js";import{V as y}from"./VBtn-92d1bfca.js";import{V as he}from"./VImg-6fedc660.js";import{V as Me}from"./VDialog-27572a26.js";import{e as Ce,V as Ye,a as Ae,c as ye,d as ke}from"./VCard-bba93bb4.js";import{V as ue}from"./VSpacer-314fab57.js";import{b as Le}from"./VToolbar-e2ec70e7.js";import{V as We}from"./VTable-b7e57a77.js";import{v as z}from"./v4-a960c1f4.js";import"./rounded-a088577e.js";import"./index-593c750c.js";import"./index-fd59b42a.js";import"./scopeId-871895a5.js";import"./VChip-ad88dbeb.js";import"./VAvatar-0f0da553.js";import"./ssrBoot-0303cbf7.js";import"./createSimpleFunctional-e6bf7656.js";var b=(n=>(n.GROUP_TYPE_ADMIN="GROUP_TYPE_ADMIN",n.GROUP_TYPE_SYSTEM="GROUP_TYPE_SYSTEM",n.GROUP_TYPE_ORGANISATION="GROUP_TYPE_ORGANISATION",n.GROUP_TYPE_CONVENTION="GROUP_TYPE_CONVENTION",n))(b||{}),R=(n=>(n.OWNER_TYPE_ADMIN="",n.OWNER_TYPE_CONVENTION="conventions",n.OWNER_TYPE_ORGANISATION="organisations",n.OWNER_TYPE_SYSTEM="",n))(R||{}),ie=(n=>(n.PERMISSION_TYPE_NULL="PERMISSION_TYPE_NULL",n.PERMISSION_TYPE_EDIT_CONVENTION="PERMISSION_TYPE_EDIT_CONVENTION",n.PERMISSION_TYPE_EDIT_ORGANISATION="PERMISSION_TYPE_EDIT_ORGANISATION",n.PERMISSION_TYPE_MANAGE_USERS="PERMISSION_TYPE_MANAGE_USERS",n.PERMISSION_TYPE_MANAGE_VIEWS="PERMISSION_TYPE_MANAGE_VIEWS",n.PERMISSION_TYPE_EDIT_REGISTRATIONS="PERMISSION_TYPE_EDIT_REGISTRATIONS",n.PERMISSION_TYPE_VIEW_REGISTRATIONS="PERMISSION_TYPE_VIEW_REGISTRATIONS",n))(ie||{});const re=Z({__name:"EditGroupPermissions",props:j({disabled:{type:Boolean}},{modelValue:{required:!0}}),emits:["update:modelValue"],setup(n){const U=le(n,"modelValue");return(O,d)=>(E(),L(X,null,{default:o(()=>[l(ee,null,{default:o(()=>[l(S,{cols:"12",sm:"6",md:"4"},{default:o(()=>[l(k,{modelValue:U.value.EditConvention,"onUpdate:modelValue":d[0]||(d[0]=I=>U.value.EditConvention=I),label:"Edit Convention","hide-details":"",disabled:O.disabled},null,8,["modelValue","disabled"])]),_:1}),l(S,{cols:"12",sm:"6",md:"4"},{default:o(()=>[l(k,{modelValue:U.value.EditOrganisation,"onUpdate:modelValue":d[1]||(d[1]=I=>U.value.EditOrganisation=I),label:"Edit Organisation","hide-details":"",disabled:O.disabled},null,8,["modelValue","disabled"])]),_:1}),l(S,{cols:"12",sm:"6",md:"4"},{default:o(()=>[l(k,{modelValue:U.value.EditRegistration,"onUpdate:modelValue":d[2]||(d[2]=I=>U.value.EditRegistration=I),label:"Edit Registrations","hide-details":"",disabled:O.disabled},null,8,["modelValue","disabled"])]),_:1}),l(S,{cols:"12",sm:"6",md:"4"},{default:o(()=>[l(k,{modelValue:U.value.ManageUsers,"onUpdate:modelValue":d[3]||(d[3]=I=>U.value.ManageUsers=I),label:"Manage Users","hide-details":"",disabled:O.disabled},null,8,["modelValue","disabled"])]),_:1}),l(S,{cols:"12",sm:"6",md:"4"},{default:o(()=>[l(k,{modelValue:U.value.ManageViews,"onUpdate:modelValue":d[4]||(d[4]=I=>U.value.ManageViews=I),label:"Manage Views","hide-details":"",disabled:O.disabled},null,8,["modelValue","disabled"])]),_:1}),l(S,{cols:"12",sm:"6",md:"4"},{default:o(()=>[l(k,{modelValue:U.value.ViewRegistration,"onUpdate:modelValue":d[5]||(d[5]=I=>U.value.ViewRegistration=I),label:"View Registrations","hide-details":"",disabled:O.disabled},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}))}}),$e=Z({__name:"EditGroupDialog",props:j({conventions:{},organisations:{},group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:j(["update:group","save"],["update:modelValue"]),setup(n,{emit:U}){const O=n,d=Q(),{conventions:I,organisations:C,title:g=""}=O,N=le(n,"modelValue"),i=te(O,U,void 0,void 0,"group"),t=p($(i.value)),f=p(null);t.value.OwnerType===R.OWNER_TYPE_CONVENTION?f.value=I.filter(u=>u.ConventionUUID==t.value.OwnerUUID).map(u=>u.ConventionUUID).join(""):t.value.OwnerType===R.OWNER_TYPE_ORGANISATION?f.value=C.filter(u=>u.OrganisationUUID==t.value.OwnerUUID).map(u=>u.OrganisationUUID).join(""):(t.value.Type===b.GROUP_TYPE_SYSTEM||t.value.Type===b.GROUP_TYPE_ADMIN)&&(f.value=null),q(i,()=>{t.value=$(i.value)});const c=p({ID:0,PermissionUUID:A,GroupID:0,GroupUUID:A,EditConvention:!1,EditOrganisation:!1,EditRegistration:!1,ViewRegistration:!1,ManageUsers:!1,ManageViews:!1});d.getPermission(b.GROUP_TYPE_SYSTEM,A).then(u=>{c.value=u,P()}).catch(()=>{});const V=()=>{t.value=$(i.value),P()},h=u=>{if(f.value==null)t.value.Type=b.GROUP_TYPE_ADMIN,t.value.OwnerType=null,t.value.OwnerID=null,t.value.OwnerUUID=null;else{const e=D.value.find(v=>f.value===v.OwnerUUID);e&&(e.OwnerType==R.OWNER_TYPE_ORGANISATION?t.value.Type=b.GROUP_TYPE_ORGANISATION:e.OwnerType==R.OWNER_TYPE_CONVENTION&&(t.value.Type=b.GROUP_TYPE_CONVENTION),t.value.OwnerType=e.OwnerType,t.value.OwnerID=e.OwnerID,t.value.OwnerUUID=e.OwnerUUID)}d.saveGroup(t.value).then(e=>{e&&u&&u("Group Saved").then(()=>{i.value=e,U("save",e)})}).catch(()=>{u&&u("Failed to Save Group")})},P=()=>{const u=D.value.find(e=>t.value.OwnerUUID===e.OwnerUUID);u?f.value=u.OwnerUUID:D.value.length>0&&(f.value=null)},D=oe(()=>{const u=[];return c.value.ManageUsers&&u.push({Label:"System Admin",OwnerID:null,OwnerUUID:null,OwnerType:null}),u.push(...I.map(e=>({Label:`${e.Name} (Convention)`,OwnerID:e.ID,OwnerUUID:e.ConventionUUID,OwnerType:R.OWNER_TYPE_CONVENTION}))),u.push(...C.map(e=>({Label:`${e.Name} (Organisation)`,OwnerID:e.ID,OwnerUUID:e.OrganisationUUID,OwnerType:R.OWNER_TYPE_ORGANISATION}))),u});return P(),(u,e)=>(E(),L(se,{modelValue:N.value,"onUpdate:modelValue":e[3]||(e[3]=v=>N.value=v),onReset:V,onSave:h,title:H(g),color:"primary","show-close-action":!0,"show-reset-action":!0,"show-save-action":!0},{default:o(()=>[l(X,{class:"pa-0",fluid:!0},{default:o(()=>[l(ee,null,{default:o(()=>[l(S,{cols:"12",md:"6"},{default:o(()=>[l(ge,{modelValue:t.value.Name,"onUpdate:modelValue":e[0]||(e[0]=v=>t.value.Name=v),label:"Name",variant:"outlined"},null,8,["modelValue"])]),_:1}),l(S,{cols:"12",md:"6"},{default:o(()=>[l(K,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=v=>f.value=v),label:"Owner",items:D.value,"item-title":"Label","item-value":"OwnerUUID",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),l(S,{cols:"12"},{default:o(()=>[l(re,{modelValue:t.value.Permission,"onUpdate:modelValue":e[2]||(e[2]=v=>t.value.Permission=v),disabled:!1},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"]))}}),xe=m("p",null," Are you sure you wish to remove this user? If they have permissions from another group these will still be usable. To add the user back into the group you may need to provide them with a new invite link. NB. Invite links are valid for 48hrs so a user could re-invite themselves with an old link. ",-1),je={key:1},Fe=["href","onClick"],Be=Z({__name:"EditGroupMembersDialog",props:j({group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:j(["update:group","save"],["update:modelValue"]),setup(n,{emit:U}){const O=n,d=Q(),I=we(),{title:C=""}=O,g=le(n,"modelValue"),N=te(O,U,void 0,void 0,"group"),i=p($(N.value)),t=p("");(i.value.Users==null||i.value.Users.length==0)&&d.getGroupMembers(i.value.GroupUUID).then(e=>{e&&(i.value.Users=e)}).catch(()=>{i.value.Users=[]}),d.getGroupInvite(i.value.GroupUUID).then(e=>{if(e){const v=new URL(location.href);v.searchParams.set("token",e),t.value=v.toString()}}),q(N,()=>{i.value=$(N.value)});const f=()=>{window.isSecureContext&&navigator.clipboard&&navigator.clipboard.writeText(t.value)},c=p(!1),V=p(-1),h=p(""),P=()=>{V.value=-1,c.value=!1},D=e=>{V.value=e,c.value=!0},u=({callback:e})=>{if(!i.value.Users){e&&(e("Failed to Remove User"),setTimeout(P,2e3));return}h.value="",V.value<0||V.value>=i.value.Users.length?(e&&e("Invalid Convention"),setTimeout(P,2e3)):d.removeUserFromGroup(i.value.Users[V.value].UserUUID,i.value.GroupUUID).then(v=>{var _;v?((_=i.value.Users)==null||_.splice(V.value,1),e&&e("User Removed")):e&&e("Failed to Remove User"),setTimeout(P,2e3)}).catch(()=>{e&&(e("Failed to Remove User"),setTimeout(P,2e3))})};return(e,v)=>(E(),L(se,{modelValue:g.value,"onUpdate:modelValue":v[1]||(v[1]=_=>g.value=_),title:H(C),color:"primary"},{default:o(()=>[l(X,{class:"pa-0",fluid:!0},{default:o(()=>[i.value.Users&&i.value.Users.length?(E(),G(x,{key:0},[l(De,null,{default:o(()=>[(E(!0),G(x,null,ne(i.value.Users,(_,W)=>(E(),L(Ge,{key:_.UserUUID},{append:o(()=>[l(y,{color:"red-darken-3",icon:"mdi:mdi-window-close",size:"x-small",onClick:F=>D(W)},null,8,["onClick"])]),prepend:o(()=>[l(he,{src:H(I)(_.UserUUID),class:"rounded-circle mr-2",height:"32",width:"32"},null,8,["src"])]),default:o(()=>[l(be,null,{default:o(()=>[M(Y(_.DisplayName)+" "+Y(_.Handle?`(${_.Handle})`:""),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),l(Me,{modelValue:c.value,"onUpdate:modelValue":v[0]||(v[0]=_=>c.value=_),width:"auto"},{default:o(()=>[l(Ce,null,{default:o(()=>[l(Ye,null,{default:o(()=>[M(" Remove User from Group ")]),_:1}),l(Ae,null,{default:o(()=>[M(" User will no longer have the permissions from this group. ")]),_:1}),l(ye,null,{default:o(()=>[l(ee,null,{default:o(()=>[l(S,null,{default:o(()=>[xe]),_:1})]),_:1})]),_:1}),l(ke,null,{default:o(()=>[l(y,{color:"primary",onClick:P},{default:o(()=>[M("Cancel")]),_:1}),l(ue),l(Se,{color:"red-darken-3",label:"Remove User",onClick:u})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)):(E(),G("p",je," No members "))]),_:1})]),actions:o(()=>[l(y,{variant:"text"},{default:o(()=>[m("a",{href:t.value,onClick:ce(f,["prevent"])},"Invite URL",8,Fe)]),_:1})]),_:1},8,["modelValue","title"]))}}),ze={key:0,class:"text-center mt-5"},qe=m("thead",null,[m("tr",null,[m("th",null,"Name"),m("th",{class:"d-none d-md-table-cell"}," Owner "),m("th",null,"Permissions"),m("th")])],-1),He={class:"d-block d-md-none mt-2"},Ze=m("strong",null,"Owner",-1),Je=m("br",null,null,-1),Ke=m("br",null,null,-1),Qe={class:"d-none d-md-table-cell"},Xe=m("br",null,null,-1),el=m("br",null,null,-1),ll=m("br",null,null,-1),bl=Z({__name:"GroupsView",emits:["pageTitle"],setup(n,{emit:U}){U("pageTitle","Manage Groups & Permissions");const O=Q(),d=Re(),I=Ne();(!d||!d.Groups.find(a=>a.Permission.ManageUsers))&&I.push("/");const C=p(!0),g=p(),N=p(),i=p([]),t=p([]),f=p([]),c=p(!1),V=p(!1),h=p(!1),D=new URL(location.href).searchParams.get("token")||"";D!==""&&(C.value=!1,O.validateGroupInviteToken(D).then(a=>{a&&(Pe(a),I.push("/dashboard"))}).catch(()=>{})),q(g,()=>{_(N.value,g.value)}),q(N,()=>{_(N.value,g.value)});const u=a=>a.OwnerType===R.OWNER_TYPE_CONVENTION?i.value.filter(r=>r.ConventionUUID===a.OwnerUUID).map(r=>r.Name).join(""):a.OwnerType===R.OWNER_TYPE_ORGANISATION?f.value.filter(r=>r.OrganisationUUID===a.OwnerUUID).map(r=>r.Name).join(""):a.OwnerType===void 0||a.OwnerType===null?"System":"Unknown",e=a=>a.OwnerType===R.OWNER_TYPE_CONVENTION?"Convention":a.OwnerType===R.OWNER_TYPE_ORGANISATION?"Organisation":a.OwnerType===void 0||a.OwnerType===null?"Global":"Unknown",v=()=>{O.getPermissionAccessList(ie.PERMISSION_TYPE_MANAGE_USERS).then(a=>{i.value=a.Conventions,f.value=a.Organisations}).catch(()=>{})},_=(a=A,r=A)=>{O.getManageableGroups(a||A,r||A).then(s=>{s&&(t.value=s)}).catch(()=>{})},W=()=>{const a={ID:0,GroupUUID:z(),Type:b.GROUP_TYPE_CONVENTION,Name:"",MinimumNumbers:0,Permission:{ID:0,PermissionUUID:z(),GroupID:0,GroupUUID:z(),EditConvention:!1,EditOrganisation:!1,EditRegistration:!1,ManageUsers:!1,ManageViews:!1,ViewRegistration:!1},Users:[],OwnerID:null,OwnerType:null,OwnerUUID:null};return a.Permission.GroupUUID=a.GroupUUID,a},F=p(W()),w=p(-1),T=p(W()),de=oe(()=>w.value===-1?"New Group":"Edit Group"),me=()=>{F.value.GroupUUID=z(),T.value=Object.assign({},W()),w.value=-1,c.value=!0},ve=a=>{w.value=t.value.indexOf(a),T.value=Object.assign({},a),V.value=!0},pe=a=>{w.value=t.value.indexOf(a),T.value=Object.assign({},a),c.value=!0},Ue=a=>{w.value=t.value.indexOf(a),T.value=Object.assign({},a),h.value=!0},Ie=()=>{O.deleteGroup(T.value.GroupUUID).then(a=>{a&&(t.value.splice(w.value,1),fe())})},Oe=()=>{c.value=!1,ae(()=>{T.value=Object.assign({},F.value),w.value=-1})},fe=()=>{h.value=!1,ae(()=>{T.value=Object.assign({},F.value),w.value=-1})},_e=a=>{w.value>-1?Object.assign(t.value[w.value],a):t.value.push(a),Oe()};return v(),_(N.value,g.value),(a,r)=>(E(),G("div",null,[C.value?(E(),G(x,{key:1},[l(Le,{color:"primary"},{default:o(()=>[l(K,{label:"Organisation",modelValue:N.value,"onUpdate:modelValue":r[0]||(r[0]=s=>N.value=s),items:f.value,"item-value":"OrganisationUUID","item-title":"Name",clearable:!0,"hide-details":"",class:"mr-1"},null,8,["modelValue","items"]),l(K,{label:"Convention",modelValue:g.value,"onUpdate:modelValue":r[1]||(r[1]=s=>g.value=s),items:i.value,"item-value":"ConventionUUID","item-title":"Name",clearable:!0,"hide-details":""},null,8,["modelValue","items"]),l(ue),l(y,{dark:"",class:"mb-2","prepend-icon":"mdi:mdi-pencil",onClick:me},{default:o(()=>[M(" New Group ")]),_:1}),l(Te,{modelValue:h.value,"onUpdate:modelValue":r[2]||(r[2]=s=>h.value=s),onDelete:Ie},null,8,["modelValue"])]),_:1}),c.value?(E(),L($e,{key:0,modelValue:c.value,"onUpdate:modelValue":r[3]||(r[3]=s=>c.value=s),group:T.value,"onUpdate:group":r[4]||(r[4]=s=>T.value=s),onSave:_e,title:de.value,conventions:i.value,organisations:f.value},null,8,["modelValue","group","title","conventions","organisations"])):J("",!0),V.value?(E(),L(Be,{key:1,modelValue:V.value,"onUpdate:modelValue":r[5]||(r[5]=s=>V.value=s),group:T.value,"onUpdate:group":r[6]||(r[6]=s=>T.value=s),title:`${T.value.Name}`},null,8,["modelValue","group","title"])):J("",!0),l(We,null,{default:o(()=>[qe,m("tbody",null,[(E(!0),G(x,null,ne(t.value,(s,Ee)=>(E(),G("tr",{key:s.GroupUUID,class:Ve(Ee%2?"bg-grey-lighten-4":"")},[m("td",null,[M(Y(s.Name)+" ",1),m("p",He,[Ze,Je,M(" "+Y(u(s)),1),Ke,m("small",null,"("+Y(e(s))+")",1)])]),m("td",Qe,[M(Y(u(s)),1),Xe,m("small",null,"("+Y(e(s))+")",1)]),m("td",null,[l(re,{modelValue:s.Permission,"onUpdate:modelValue":B=>s.Permission=B,disabled:!0},null,8,["modelValue","onUpdate:modelValue"])]),m("td",null,[l(y,{icon:"mdi:mdi-account-group",size:"x-small",color:"success",class:"mb-1",onClick:B=>ve(s)},null,8,["onClick"]),el,s.Type!==H(b).GROUP_TYPE_SYSTEM?(E(),G(x,{key:0},[l(y,{icon:"mdi:mdi-pencil",size:"x-small",color:"primary",class:"mb-1",onClick:B=>pe(s)},null,8,["onClick"]),ll,l(y,{icon:"mdi:mdi-delete",size:"x-small",color:"error",class:"mb-1",onClick:B=>Ue(s)},null,8,["onClick"])],64)):J("",!0)])],2))),128))])]),_:1})],64)):(E(),G("h1",ze,"Processing Invite"))]))}});export{bl as default};
