import{I as J,a0 as B,a1 as le,M as V,N as k,O as a,v as e,r as U,K as W,w as Q,e as ne,W as X,a3 as ae,V as G,H as F,a4 as ie,P as M,Q as C,X as m,R as Te,a6 as _e,S as j,ac as we,E as se}from"./index-f3974254.js";import{O as P,G as S}from"./group-d2a77946.js";import{P as Ne}from"./permission-03f04c02.js";import{j as te}from"./VContainer-5936b72d.js";import{a as b,V as oe}from"./VRow-a42cd667.js";import{V as Y,u as ue}from"./VCheckbox-48017a2a.js";import{_ as ye}from"./DeleteDialog.vue_vue_type_script_setup_true_lang-2521892b.js";import{_ as re}from"./ModelDialog.vue_vue_type_script_setup_true_lang-4d62a609.js";import{V as De}from"./VTextField-109bae69.js";import{V as ee,c as be}from"./copyToClipboard-e35d1e22.js";import{u as x}from"./nil-d01db1aa.js";import{G as Ee,A as he}from"./userData-b9203568.js";import{u as Ge}from"./useAvatar-4d5b16dd.js";import{_ as Pe,l as Re}from"./SaveButton.vue_vue_type_script_setup_true_lang-fb378d1d.js";import{V as Ce,a as Se,c as ke}from"./VList-ec0b39b8.js";import{V as L}from"./VBtn-03ff202e.js";import{V as Me}from"./VAvatar-39457736.js";import{V as Ae}from"./VDialog-5629aef3.js";import{e as Ye,V as xe,a as Le,c as je,d as $e}from"./VCard-0b5fdb6c.js";import{V as de}from"./scopeId-3a89bdd4.js";import{a as We,V as Fe}from"./VTable-17605927.js";import{V as Be}from"./VToolbar-f011b4bf.js";import{v as K}from"./v4-a960c1f4.js";import"./forwardRefs-ffbc3f83.js";import"./VChip-534fc11c.js";import"./createSimpleFunctional-fabfe47a.js";import"./VDivider-1acf697a.js";const me=J({__name:"EditGroupPermissions",props:B({disabled:{type:Boolean}},{modelValue:{required:!0}}),emits:["update:modelValue"],setup(R){const p=le(R,"modelValue");return(f,d)=>(V(),k(te,null,{default:a(()=>[e(oe,null,{default:a(()=>[e(b,{cols:"12",sm:"6",md:"4"},{default:a(()=>[e(Y,{modelValue:p.value.EditConvention,"onUpdate:modelValue":d[0]||(d[0]=v=>p.value.EditConvention=v),label:"Edit Convention","hide-details":"",disabled:f.disabled},null,8,["modelValue","disabled"])]),_:1}),e(b,{cols:"12",sm:"6",md:"4"},{default:a(()=>[e(Y,{modelValue:p.value.EditOrganisation,"onUpdate:modelValue":d[1]||(d[1]=v=>p.value.EditOrganisation=v),label:"Edit Organisation","hide-details":"",disabled:f.disabled},null,8,["modelValue","disabled"])]),_:1}),e(b,{cols:"12",sm:"6",md:"4"},{default:a(()=>[e(Y,{modelValue:p.value.EditPaymentTransactions,"onUpdate:modelValue":d[2]||(d[2]=v=>p.value.EditPaymentTransactions=v),label:"Manage Registration Payments","hide-details":"",disabled:f.disabled},null,8,["modelValue","disabled"])]),_:1}),e(b,{cols:"12",sm:"6",md:"4"},{default:a(()=>[e(Y,{modelValue:p.value.EditRegistration,"onUpdate:modelValue":d[3]||(d[3]=v=>p.value.EditRegistration=v),label:"Edit Registrations","hide-details":"",disabled:f.disabled},null,8,["modelValue","disabled"])]),_:1}),e(b,{cols:"12",sm:"6",md:"4"},{default:a(()=>[e(Y,{modelValue:p.value.ManageUsers,"onUpdate:modelValue":d[4]||(d[4]=v=>p.value.ManageUsers=v),label:"Manage Users","hide-details":"",disabled:f.disabled},null,8,["modelValue","disabled"])]),_:1}),e(b,{cols:"12",sm:"6",md:"4"},{default:a(()=>[e(Y,{modelValue:p.value.ManageViews,"onUpdate:modelValue":d[5]||(d[5]=v=>p.value.ManageViews=v),label:"Manage Views","hide-details":"",disabled:f.disabled},null,8,["modelValue","disabled"])]),_:1}),e(b,{cols:"12",sm:"6",md:"4"},{default:a(()=>[e(Y,{modelValue:p.value.ViewRegistration,"onUpdate:modelValue":d[6]||(d[6]=v=>p.value.ViewRegistration=v),label:"View Registrations","hide-details":"",disabled:f.disabled},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}))}}),ze=J({__name:"EditGroupDialog",props:B({conventions:{},organisations:{},group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:B(["update:group","save"],["update:modelValue"]),setup(R,{emit:p}){const f=R,d=ae(),{conventions:v,organisations:A,title:w=""}=f,I=le(R,"modelValue"),r=ue(f,p,void 0,void 0,"group"),t=U(W(r.value)),c=U(null);t.value.OwnerType===P.OWNER_TYPE_CONVENTION?c.value=v.filter(i=>i.ConventionUUID==t.value.OwnerUUID).map(i=>i.ConventionUUID).join(""):t.value.OwnerType===P.OWNER_TYPE_ORGANISATION?c.value=A.filter(i=>i.OrganisationUUID==t.value.OwnerUUID).map(i=>i.OrganisationUUID).join(""):(t.value.Type===S.GROUP_TYPE_SYSTEM||t.value.Type===S.GROUP_TYPE_ADMIN)&&(c.value=null),Q(r,()=>{t.value=W(r.value)});const N=U({ID:0,PermissionUUID:x,GroupID:0,GroupUUID:x,EditConvention:!1,EditOrganisation:!1,EditPaymentTransactions:!1,EditRegistration:!1,ViewRegistration:!1,ManageUsers:!1,ManageViews:!1});d.getPermission(S.GROUP_TYPE_SYSTEM,x).then(i=>{N.value=i,E()}).catch(()=>{});const y=()=>{t.value=W(r.value),E()},g=i=>{if(c.value==null)t.value.Type=S.GROUP_TYPE_ADMIN,t.value.OwnerType=null,t.value.OwnerID=null,t.value.OwnerUUID=null;else{const s=D.value.find(n=>c.value===n.OwnerUUID);s&&(s.OwnerType==P.OWNER_TYPE_ORGANISATION?t.value.Type=S.GROUP_TYPE_ORGANISATION:s.OwnerType==P.OWNER_TYPE_CONVENTION&&(t.value.Type=S.GROUP_TYPE_CONVENTION),t.value.OwnerType=s.OwnerType,t.value.OwnerID=s.OwnerID,t.value.OwnerUUID=s.OwnerUUID)}d.saveGroup(t.value).then(s=>{s&&i&&i("Group Saved").then(()=>{r.value=s,p("save",s)})}).catch(()=>{i&&i("Failed to Save Group")})},E=()=>{const i=D.value.find(s=>t.value.OwnerUUID===s.OwnerUUID);i?c.value=i.OwnerUUID:D.value.length>0&&(c.value=null)},D=ne(()=>{const i=[];return N.value.ManageUsers&&i.push({Label:"System Admin",OwnerID:null,OwnerUUID:null,OwnerType:null}),i.push(...v.map(s=>({Label:`${s.Name} (Convention)`,OwnerID:s.ID,OwnerUUID:s.ConventionUUID,OwnerType:P.OWNER_TYPE_CONVENTION}))),i.push(...A.map(s=>({Label:`${s.Name} (Organisation)`,OwnerID:s.ID,OwnerUUID:s.OrganisationUUID,OwnerType:P.OWNER_TYPE_ORGANISATION}))),i});return E(),(i,s)=>(V(),k(re,{modelValue:I.value,"onUpdate:modelValue":s[3]||(s[3]=n=>I.value=n),onReset:y,onSave:g,title:X(w),color:"primary","show-close-action":!0,"show-reset-action":!0,"show-save-action":!0,fullscreen:!0,persistent:!0},{default:a(()=>[e(te,{class:"pa-0",fluid:!0},{default:a(()=>[e(oe,null,{default:a(()=>[e(b,{cols:"12",md:"6"},{default:a(()=>[e(De,{modelValue:t.value.Name,"onUpdate:modelValue":s[0]||(s[0]=n=>t.value.Name=n),label:"Name",variant:"outlined"},null,8,["modelValue"])]),_:1}),e(b,{cols:"12",md:"6"},{default:a(()=>[e(ee,{modelValue:c.value,"onUpdate:modelValue":s[1]||(s[1]=n=>c.value=n),label:"Owner",items:D.value,"item-title":"Label","item-value":"OwnerUUID",variant:"outlined"},null,8,["modelValue","items"])]),_:1}),e(b,{cols:"12"},{default:a(()=>[e(me,{modelValue:t.value.Permission,"onUpdate:modelValue":s[2]||(s[2]=n=>t.value.Permission=n),disabled:!1},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"]))}}),qe=m("p",null," Are you sure you wish to remove this user? If they have permissions from another group these will still be usable. To add the user back into the group you may need to provide them with a new invite link. ",-1),He={key:1},Ke=["href","onClick"],Qe=J({__name:"EditGroupMembersDialog",props:B({group:{},title:{}},{modelValue:{type:Boolean,required:!0}}),emits:B(["update:group","save"],["update:modelValue"]),setup(R,{emit:p}){const f=R,d=ae(),v=Ge(),{title:A=""}=f,w=le(R,"modelValue"),I=ue(f,p,void 0,void 0,"group"),r=U(W(I.value));(r.value.Users==null||r.value.Users.length==0)&&d.getGroupMembers(r.value.GroupUUID).then(n=>{n&&(r.value.Users=n)}).catch(()=>{r.value.Users=[]});const t=U(""),c=()=>{d.getGroupInvite(r.value.GroupUUID).then(n=>{if(n){const T=new URL(location.href);T.searchParams.set("token",n),t.value=T.toString()}})};c(),Q(I,()=>{r.value=W(I.value)});const N=()=>{be(t.value),c()},y=U(!1),g=U(-1),E=U(""),D=()=>{g.value=-1,y.value=!1},i=n=>{g.value=n,y.value=!0},s=({callback:n})=>{if(!r.value.Users){n&&(n("Failed to Remove User"),setTimeout(D,2e3));return}E.value="",g.value<0||g.value>=r.value.Users.length?(n&&n("Invalid Convention"),setTimeout(D,2e3)):d.removeUserFromGroup(r.value.Users[g.value].UserUUID,r.value.GroupUUID).then(T=>{var O;T?((O=r.value.Users)==null||O.splice(g.value,1),n&&n("User Removed")):n&&n("Failed to Remove User"),setTimeout(D,2e3)}).catch(()=>{n&&(n("Failed to Remove User"),setTimeout(D,2e3))})};return(n,T)=>(V(),k(re,{modelValue:w.value,"onUpdate:modelValue":T[1]||(T[1]=O=>w.value=O),title:X(A),color:"primary",fullscreen:!0,persistent:!0},{default:a(()=>[e(te,{class:"pa-0",fluid:!0},{default:a(()=>[r.value.Users&&r.value.Users.length?(V(),G(F,{key:0},[e(Ce,null,{default:a(()=>[(V(!0),G(F,null,ie(r.value.Users,(O,$)=>(V(),k(Se,{key:O.UserUUID},{append:a(()=>[e(L,{color:"red-darken-3",icon:"mdi:mdi-window-close",size:"x-small",onClick:z=>i($)},null,8,["onClick"])]),prepend:a(()=>[e(Me,{src:X(v)(O.UserUUID),class:"rounded-circle mr-2",height:"32",width:"32"},null,8,["src"])]),default:a(()=>[e(ke,null,{default:a(()=>[M(C(O.DisplayName)+" "+C(O.Handle?`(${O.Handle})`:""),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(Ae,{modelValue:y.value,"onUpdate:modelValue":T[0]||(T[0]=O=>y.value=O),width:"auto"},{default:a(()=>[e(Ye,null,{default:a(()=>[e(xe,null,{default:a(()=>[M(" Remove User from Group ")]),_:1}),e(Le,null,{default:a(()=>[M(" User will no longer have the permissions from this group. ")]),_:1}),e(je,null,{default:a(()=>[e(oe,null,{default:a(()=>[e(b,null,{default:a(()=>[qe]),_:1})]),_:1})]),_:1}),e($e,null,{default:a(()=>[e(L,{color:"primary",onClick:D},{default:a(()=>[M("Cancel")]),_:1}),e(de),e(Pe,{color:"red-darken-3",label:"Remove User",onClick:s})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)):(V(),G("p",He," No members "))]),_:1})]),actions:a(()=>[e(L,{variant:"text"},{default:a(()=>[m("a",{href:t.value,onClick:Te(N,["prevent"])},"Invite URL",8,Ke)]),_:1})]),_:1},8,["modelValue","title"]))}}),Xe=m("h1",{class:"text-center mt-5"},"Processing Invite...",-1),Je={key:0,class:"text-center mt-5 text-red text-h5"},Ze={key:1,class:"text-center mt-5"},el=m("thead",null,[m("tr",null,[m("th",null,"Name"),m("th",{class:"d-none d-md-table-cell"}," Owner "),m("th",null,"Permissions"),m("th")])],-1),ll={class:"d-block d-md-none mt-2"},al=m("strong",null,"Owner",-1),tl=m("br",null,null,-1),ol=m("br",null,null,-1),sl={class:"d-none d-md-table-cell"},nl=m("br",null,null,-1),il=m("br",null,null,-1),ul=m("br",null,null,-1),Ml=J({__name:"GroupsView",emits:["pageTitle"],setup(R,{emit:p}){p("pageTitle","Manage Groups & Permissions");const f=ae(),d=Ee(),v=_e(),A=U(!1),w=U(),I=U(),r=U([]),t=U([]),c=U([]),N=U(!1),y=U(!1),g=U(!1),E=U(""),i=new URL(location.href).searchParams.get("token")||"",s=l=>{const u=()=>{const o=sessionStorage.getItem("gjt_attempt");let q=Re.parseInt(o||"0");q<2?(sessionStorage.setItem("gjt_attempt",(q+1).toString()),setTimeout(()=>{location.reload()},2e3)):(sessionStorage.removeItem("gjt_attempt"),localStorage.removeItem("gjt_token"),E.value="There was a problem with this token, it may have expired or already been used.",setTimeout(()=>{v.push("/")},5e3))};f.validateGroupInviteToken(l).then(o=>{o?(he(o),localStorage.removeItem("gjt_token"),sessionStorage.setItem("reload","true"),v.push("/")):u()}).catch(()=>{u()})};i!==""?(localStorage.setItem("gjt_token",location.href),s(i)):(A.value=!0,(!d||!d.Groups.find(l=>l.Permission.ManageUsers))&&v.push("/")),Q(w,()=>{$(I.value,w.value)}),Q(I,()=>{$(I.value,w.value)});const n=l=>l.OwnerType===P.OWNER_TYPE_CONVENTION?r.value.filter(u=>u.ConventionUUID===l.OwnerUUID).map(u=>u.Name).join(""):l.OwnerType===P.OWNER_TYPE_ORGANISATION?c.value.filter(u=>u.OrganisationUUID===l.OwnerUUID).map(u=>u.Name).join(""):l.OwnerType===void 0||l.OwnerType===null?"System":"Unknown",T=l=>l.OwnerType===P.OWNER_TYPE_CONVENTION?"Convention":l.OwnerType===P.OWNER_TYPE_ORGANISATION?"Organisation":l.OwnerType===void 0||l.OwnerType===null?"Global":"Unknown",O=()=>{f.getPermissionAccessList(Ne.PERMISSION_TYPE_MANAGE_USERS).then(l=>{r.value=l.Conventions,c.value=l.Organisations}).catch(()=>{})},$=(l=x,u=x)=>{f.getManageableGroups(l||x,u||x).then(o=>{o&&(t.value=o)}).catch(()=>{})},z=()=>{const l={ID:0,GroupUUID:K(),Type:S.GROUP_TYPE_CONVENTION,Name:"",MinimumNumbers:0,Permission:{ID:0,PermissionUUID:K(),GroupID:0,GroupUUID:K(),EditConvention:!1,EditOrganisation:!1,EditPaymentTransactions:!1,EditRegistration:!1,ManageUsers:!1,ManageViews:!1,ViewRegistration:!1},Users:[],OwnerID:null,OwnerType:null,OwnerUUID:null};return l.Permission.GroupUUID=l.GroupUUID,l},Z=U(z()),h=U(-1),_=U(z()),ve=ne(()=>h.value===-1?"New Group":"Edit Group"),pe=()=>{Z.value.GroupUUID=K(),_.value=Object.assign({},z()),h.value=-1,N.value=!0},Ue=l=>{h.value=t.value.indexOf(l),_.value=Object.assign({},l),y.value=!0},fe=l=>{h.value=t.value.indexOf(l),_.value=Object.assign({},l),N.value=!0},ce=l=>{h.value=t.value.indexOf(l),_.value=Object.assign({},l),g.value=!0},Ve=()=>{f.deleteGroup(_.value.GroupUUID).then(l=>{l&&(t.value.splice(h.value,1),Ie())})},Oe=()=>{N.value=!1,se(()=>{_.value=Object.assign({},Z.value),h.value=-1})},Ie=()=>{g.value=!1,se(()=>{_.value=Object.assign({},Z.value),h.value=-1})},ge=l=>{h.value>-1?Object.assign(t.value[h.value],l):t.value.push(l),Oe()};return O(),$(I.value,w.value),(l,u)=>(V(),G("div",null,[A.value?(V(),G(F,{key:1},[e(Be,{color:"primary"},{default:a(()=>[e(ee,{label:"Organisation",modelValue:I.value,"onUpdate:modelValue":u[0]||(u[0]=o=>I.value=o),items:c.value,"item-value":"OrganisationUUID","item-title":"Name",clearable:!0,"hide-details":"",class:"mr-1"},null,8,["modelValue","items"]),e(ee,{label:"Convention",modelValue:w.value,"onUpdate:modelValue":u[1]||(u[1]=o=>w.value=o),items:r.value,"item-value":"ConventionUUID","item-title":"Name",clearable:!0,"hide-details":""},null,8,["modelValue","items"]),e(de),e(L,{dark:"",class:"mb-2","prepend-icon":"mdi:mdi-pencil",onClick:pe},{default:a(()=>[M(" New Group ")]),_:1}),e(ye,{modelValue:g.value,"onUpdate:modelValue":u[2]||(u[2]=o=>g.value=o),onDelete:Ve},null,8,["modelValue"])]),_:1}),N.value?(V(),k(ze,{key:0,modelValue:N.value,"onUpdate:modelValue":u[3]||(u[3]=o=>N.value=o),group:_.value,"onUpdate:group":u[4]||(u[4]=o=>_.value=o),onSave:ge,title:ve.value,conventions:r.value,organisations:c.value},null,8,["modelValue","group","title","conventions","organisations"])):j("",!0),y.value?(V(),k(Qe,{key:1,modelValue:y.value,"onUpdate:modelValue":u[5]||(u[5]=o=>y.value=o),group:_.value,"onUpdate:group":u[6]||(u[6]=o=>_.value=o),title:`${_.value.Name}`},null,8,["modelValue","group","title"])):j("",!0),e(Fe,null,{default:a(()=>[el,m("tbody",null,[(V(!0),G(F,null,ie(t.value,(o,q)=>(V(),G("tr",{key:o.GroupUUID,class:we(q%2?"bg-grey-lighten-4":"")},[m("td",null,[M(C(o.Name)+" ",1),m("p",ll,[al,tl,M(" "+C(n(o)),1),ol,m("small",null,"("+C(T(o))+")",1)])]),m("td",sl,[M(C(n(o)),1),nl,m("small",null,"("+C(T(o))+")",1)]),m("td",null,[o.Permission?(V(),k(me,{key:0,modelValue:o.Permission,"onUpdate:modelValue":H=>o.Permission=H,disabled:!0},null,8,["modelValue","onUpdate:modelValue"])):j("",!0)]),m("td",null,[e(L,{icon:"mdi:mdi-account-group",size:"x-small",color:"success",class:"mb-1",onClick:H=>Ue(o)},null,8,["onClick"]),il,o.Type!==X(S).GROUP_TYPE_SYSTEM?(V(),G(F,{key:0},[e(L,{icon:"mdi:mdi-pencil",size:"x-small",color:"primary",class:"mb-1",onClick:H=>fe(o)},null,8,["onClick"]),ul,e(L,{icon:"mdi:mdi-delete",size:"x-small",color:"error",class:"mb-1",onClick:H=>ce(o)},null,8,["onClick"])],64)):j("",!0)])],2))),128))])]),_:1})],64)):(V(),k(We,{key:0,elevation:"2",class:"pa-4"},{default:a(()=>[Xe,E.value?(V(),G("p",Je,C(E.value),1)):j("",!0),E.value?(V(),G("p",Ze,"Please contact your admin and request a new one")):j("",!0)]),_:1}))]))}});export{Ml as default};
